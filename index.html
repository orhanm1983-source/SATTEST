<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital SAT Practice Exam</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --blue: #0071ce; --dark: #1e1e1e; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); color: #333; }
        
        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© --- */
        sup { font-size: 0.75em; vertical-align: super; }
        sub { font-size: 0.75em; vertical-align: sub; }
        
        /* Ø§Ù„ÙƒØ³Ø± Ø§Ù„Ø±Ø£Ø³ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .math-frac {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 0.95em;
            margin: 0 4px;
        }
        .math-frac .num { display: block; border-bottom: 1.5px solid #333; padding: 0 5px; }
        .math-frac .den { display: block; padding: 0 5px; }

        /* Ø§Ù„Ø¬Ø°Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .math-root {
            display: inline-block;
            white-space: nowrap;
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }
        .root-symbol { font-size: 1.2em; vertical-align: middle; }
        .root-content {
            border-top: 1.5px solid #333;
            padding-top: 1px;
            margin-left: -3px;
            display: inline-block;
            vertical-align: middle;
        }

        /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø§Øª --- */
        .setup-screen, .exam-screen { max-width: 900px; margin: 40px auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 25px; }
        .timer { background: #fee2e2; color: #dc2626; padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; border: 1px solid #fecaca; }
        .q-area { min-height: 280px; }
        .options { display: grid; gap: 15px; margin-top: 25px; }
        .opt-btn { padding: 18px; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; text-align: left; transition: all 0.2s ease; background: white; font-size: 1.05rem; display: flex; align-items: center; }
        .opt-btn:hover { border-color: var(--blue); background: #f0f7ff; transform: translateY(-2px); }
        .opt-btn.active { border-color: var(--blue); background: #e6f2ff; border-width: 2px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,113,206,0.1); }
        .grid-input { width: 100%; padding: 18px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1.2rem; transition: border-color 0.3s; }
        .grid-input:focus { border-color: var(--blue); outline: none; }
        .footer { display: flex; justify-content: space-between; margin-top: 40px; }
        .btn { padding: 14px 30px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .btn-primary { background: var(--blue); color: white; }
        .btn-primary:hover { opacity: 0.9; box-shadow: 0 4px 15px rgba(0,113,206,0.3); }
        .btn-secondary { background: #6b7280; color: white; }
        input[type="text"], input[type="email"], input[type="tel"] { width: 100%; padding: 14px; margin-bottom: 20px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="setupScreen" class="setup-screen">
        <h1 style="color: var(--blue); margin-top: 0;">Student Registration</h1>
        <p style="color: #666; margin-bottom: 30px;">Please enter your details to begin the practice test.</p>
        <input type="text" id="stuName" placeholder="Full Name" required>
        <input type="email" id="stuEmail" placeholder="Email Address" required>
        <input type="tel" id="stuPhone" placeholder="Phone Number" required>
        <button class="btn btn-primary" style="width: 100%; padding: 18px; font-size: 1.1rem;" onclick="initExam()">Start Official Test</button>
    </div>

    <div id="examScreen" class="exam-screen" style="display: none;">
        <div class="header">
            <div><span id="modLabel" style="font-weight: bold; color: var(--blue); font-size: 1.1rem;">Module 1</span> | <span id="qCount" style="color: #666;">Question 1/22</span></div>
            <div class="timer" id="timerDisplay">70:00</div>
        </div>
        <div class="q-area" id="qArea"></div>
        <div class="footer">
            <button class="btn btn-secondary" onclick="moveQ(-1)">Previous</button>
            <button class="btn btn-primary" onclick="moveQ(1)" id="nextBtn">Next Question</button>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Øª (ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¢Ù†)
        const EXAM_OPEN_DATE = new Date(); 

        let config = { name: "", email: "", phone: "" };
        let examData = { m1: [], m2: [] };
        let currentModule = 1;
        let currentIdx = 0;
        let userAnswers = { m1: {}, m2: {} };
        let timeLeft = 70 * 60;

        const PUBLIC_KEY = "kaJmN11jIcapGxZSh";
        const SERVICE_ID = "service_oq1o551";
        const TEMPLATE_ID = "template_ks5ngtc";

        emailjs.init(PUBLIC_KEY);

        async function initExam() {
            config.name = document.getElementById('stuName').value;
            config.email = document.getElementById('stuEmail').value;
            config.phone = document.getElementById('stuPhone').value;

            if(!config.name || !config.email || !config.phone) return alert("Please fill all fields!");

            try {
                const [r1, r2] = await Promise.all([fetch('module1.json'), fetch('module2.json')]);
                examData.m1 = await r1.json();
                examData.m2 = await r2.json();
                
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('examScreen').style.display = 'block';
                
                renderQuestion();
                startTimer();
            } catch(e) {
                alert("Error: Make sure module1.json and module2.json are uploaded to GitHub.");
            }
        }

        // --- Ù…Ø­Ø±Ùƒ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ---
        function formatMath(text) {
            if (!text) return "";
            return text.toString()
                // 1. Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ø±Ø£Ø³ÙŠØ©: frac(top/bottom)
                .replace(/frac\(([^/]+)\/([^)]+)\)/g, '<span class="math-frac"><span class="num">$1</span><span class="den">$2</span></span>')
                // 2. Ø§Ù„Ø¬Ø°ÙˆØ±: root(content)
                .replace(/root\(([^)]+)\)/g, '<span class="math-root"><span class="root-symbol">&radic;</span><span class="root-content">$1</span></span>')
                // 3. Ø§Ù„Ø£Ø³Ø³: ^2 Ø£Ùˆ ^(x+1)
                .replace(/\^(\(([^)]+)\)|(\w+))/g, (match, p1, p2, p3) => `<sup>${p2 || p3}</sup>`);
        }

        function renderQuestion() {
            const list = currentModule === 1 ? examData.m1 : examData.m2;
            const q = list[currentIdx];
            const area = document.getElementById('qArea');
            const saved = userAnswers[`m${currentModule}`][currentIdx];

            document.getElementById('modLabel').innerText = `Module ${currentModule}`;
            document.getElementById('qCount').innerText = `Question ${currentIdx + 1} of ${list.length}`;

            let html = `<div style="font-size: 1.3rem; line-height: 1.8; margin-bottom:30px; font-weight: 400;">${formatMath(q.text)}</div>`;

            if(q.type === 'mcq') {
                html += `<div class="options">`;
                q.choices.forEach((c, i) => {
                    const label = String.fromCharCode(65+i);
                    html += `<button class="opt-btn ${saved === i ? 'active' : ''}" onclick="selectOpt(${i})">
                                <span style="margin-right:15px; color:var(--blue); font-weight:bold;">${label}.</span> 
                                <span>${formatMath(c)}</span>
                             </button>`;
                });
                html += `</div>`;
            } else {
                html += `<div style="margin-top:20px;">
                            <p style="color:#666; font-size:0.9rem; margin-bottom:10px;">Enter your numeric answer below:</p>
                            <input type="text" class="grid-input" placeholder="Value..." oninput="selectOpt(this.value)" value="${saved || ''}">
                         </div>`;
            }

            area.innerHTML = html;
            document.getElementById('nextBtn').innerText = (currentIdx === list.length - 1) ? (currentModule === 1 ? "Finish Module" : "Submit Exam") : "Next Question";
        }

        function selectOpt(val) {
            userAnswers[`m${currentModule}`][currentIdx] = val;
            if(examData[`m${currentModule}`][currentIdx].type === 'mcq') renderQuestion();
        }

        function moveQ(step) {
            const list = currentModule === 1 ? examData.m1 : examData.m2;
            if(step === 1 && currentIdx === list.length - 1) {
                if(currentModule === 1) {
                    if(confirm("Are you sure you want to finish Module 1 and move to Module 2?")) { 
                        currentModule = 2; 
                        currentIdx = 0; 
                        renderQuestion(); 
                        window.scrollTo(0,0);
                    }
                } else {
                    if(confirm("Submit your final answers for scoring?")) finishExam();
                }
                return;
            }
            let newIdx = currentIdx + step;
            if(newIdx >= 0 && newIdx < list.length) { 
                currentIdx = newIdx; 
                renderQuestion(); 
                window.scrollTo(0,0);
            }
        }

        function startTimer() {
            const countdown = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    let m = Math.floor(timeLeft/60), s = timeLeft%60;
                    document.getElementById('timerDisplay').innerText = `${m}:${s<10?'0':''}${s}`;
                } else { clearInterval(countdown); finishExam(); }
            }, 1000);
        }

        function finishExam() {
            let score = 0;
            let total = examData.m1.length + examData.m2.length;
            examData.m1.forEach((q, i) => { if(userAnswers.m1[i] == q.answer) score++; });
            examData.m2.forEach((q, i) => { if(userAnswers.m2[i] == q.answer) score++; });
            let satScore = Math.round((score / total) * 800);

            emailjs.send(SERVICE_ID, TEMPLATE_ID, {
                from_name: config.name,
                from_email: config.email,
                phone: config.phone,
                score_summary: `Score: ${score}/${total} (~${satScore}/800)`,
                answers: JSON.stringify(userAnswers)
            }).then(() => {
                document.getElementById('examScreen').innerHTML = `
                <div style="text-align:center; padding:60px 20px;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ‰</div>
                    <h1 style="color:var(--blue); font-size: 2.5rem;">Test Submitted!</h1>
                    <div style="font-size: 2.2rem; color: #2e7d32; font-weight: bold; margin: 30px 0;">Estimated Score: ${satScore} / 800</div>
                    <p style="font-size: 1.1rem; color: #666;">Well done, ${config.name}. Your results have been sent to your teacher.</p>
                </div>`;
            });
        }
    </script>
</body>
</html>
