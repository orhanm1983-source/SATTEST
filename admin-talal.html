<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - TALAL.TEK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$']],
          processEscapes: true
        },
        showProcessingMessages: false,
        messageStyle: "none"
      });
    </script>

    <style>
        :root { --primary: #3498db; --secondary: #2ecc71; --accent: #9b59b6; --money: #f39c12; --danger: #e74c3c; --dark: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        .sidebar { width: 260px; background: var(--dark); color: white; height: 100vh; position: fixed; padding: 20px 0; }
        .sidebar-header { padding: 0 20px 30px; border-bottom: 1px solid #334155; margin-bottom: 20px; text-align: center; }
        .nav-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; color: #94a3b8; }
        .nav-item:hover, .nav-item.active { background: #334155; color: white; border-right: 4px solid var(--primary); }
        .main-content { margin-left: 260px; padding: 40px; width: calc(100% - 280px); box-sizing: border-box; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; }
        h3 { margin-top: 0; color: var(--dark); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #475569; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        .toolbar { background: #f8fafc; border: 1px solid #cbd5e1; border-bottom: none; padding: 8px; border-top-left-radius: 10px; border-top-right-radius: 10px; display: flex; gap: 8px; }
        .tool-btn { background: white; border: 1px solid #cbd5e1; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        .tool-btn:hover { background: var(--primary); color: white; }
        .preview-box { background: #fffbeb; border: 1px dashed #f59e0b; padding: 15px; border-radius: 10px; margin-top: 10px; min-height: 40px; }
        .btn { border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; width: 100%; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--secondary); }
        .btn-purple { background: var(--accent); }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #64748b; }
        .data-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><h2 style="color:var(--primary)">TALAL.TEK</h2><small>Control Center v3.0</small></div>
    <div class="nav-item active" onclick="showSection('videoSec')"><i class="fas fa-video"></i> Lessons & Videos</div>
    <div class="nav-item" onclick="showSection('unitQSec')"><i class="fas fa-edit"></i> Unit Quizzes</div>
    <div class="nav-item" onclick="showSection('finalExamSec')"><i class="fas fa-file-invoice"></i> Final Exams</div>
    <div class="nav-item" onclick="showSection('studentSec')"><i class="fas fa-users"></i> Student Database</div>
    <div class="nav-item" style="color: var(--money);" onclick="showSection('financeSec')"><i class="fas fa-file-invoice-dollar"></i> Financial & Access</div>
</div>

<div class="main-content">
    <div id="videoSec" class="card section">
        <h3><i class="fas fa-plus-circle"></i> Add Video Lesson</h3>
        <div class="form-grid">
            <div class="form-group"><label>Unit Number</label><input type="text" id="vUnit" placeholder="Unit 1"></div>
            <div class="form-group"><label>Lesson Title</label><input type="text" id="vTitle" placeholder="Lesson Name"></div>
        </div>
        <div class="form-group"><label>YouTube Embed Link</label><input type="text" id="vUrl"></div>
        <button class="btn btn-blue" onclick="saveItem('video')">Add Lesson</button>
    </div>

    <div id="unitQSec" class="card section hidden">
        <h3><i class="fas fa-pen-alt"></i> Unit Quiz Builder</h3>
        <div class="form-grid">
            <div class="form-group"><label>Target Unit</label><select id="uTarget"><option>Unit 1</option><option>Unit 2</option><option>Unit 3</option></select></div>
            <div class="form-group"><label>Type</label><select id="uType" onchange="toggleInputs('u')"><option value="mcq">MCQ</option><option value="gridin">Grid-in</option></select></div>
        </div>
        <div class="form-group">
            <label>Question Content</label>
            <div class="toolbar">
                <button class="tool-btn" onclick="insertMath('uText', 'sqrt')">√x</button>
                <button class="tool-btn" onclick="insertMath('uText', 'frac')">a/b</button>
                <button class="tool-btn" onclick="insertMath('uText', 'pow')">x²</button>
                <button class="tool-btn" onclick="insertMath('uText', 'bold')">B</button>
            </div>
            <textarea id="uText" rows="4" oninput="updatePreview('u')" placeholder="Type text or $math$ here..."></textarea>
        </div>
        <div class="form-group"><label>Image Link</label><input type="text" id="uImg" oninput="updatePreview('u')"></div>
        <div class="preview-box">
            <small style="color:#f59e0b">Live Preview:</small>
            <div id="uMathPreview"></div>
            <img id="uImgPreview" style="max-width:100%; display:none; margin-top:10px; border-radius:8px;">
        </div>
        <div id="uMcqArea" class="form-grid" style="margin-top:15px;">
            <input type="text" id="uA" placeholder="Option A"><input type="text" id="uB" placeholder="Option B">
            <input type="text" id="uC" placeholder="Option C"><input type="text" id="uD" placeholder="Option D">
        </div>
        <div id="uGridArea" class="form-group hidden"><label>Correct Answer</label><input type="text" id="uCorrect"></div>
        <button class="btn btn-green" onclick="saveItem('unitQ')">Save Question</button>
    </div>

    <div id="finalExamSec" class="card section hidden">
        <h3><i class="fas fa-trophy"></i> Final Mock Exam</h3>
        <div class="form-grid">
            <div class="form-group"><label>Exam Name</label><input type="text" id="fSet" placeholder="Test 1"></div>
            <div class="form-group"><label>Module</label><select id="fModule"><option value="M1">Module 1</option><option value="M2">Module 2</option></select></div>
        </div>
        <div class="form-group">
            <label>Question Content</label>
            <div class="toolbar">
                <button class="tool-btn" onclick="insertMath('fText', 'sqrt')">√x</button>
                <button class="tool-btn" onclick="insertMath('fText', 'frac')">a/b</button>
                <button class="tool-btn" onclick="insertMath('fText', 'pow')">x²</button>
            </div>
            <textarea id="fText" rows="4" oninput="updatePreview('f')"></textarea>
        </div>
        <div class="preview-box" style="background:#f0fdf4;">
            <div id="fMathPreview"></div>
        </div>
        <button class="btn btn-purple" onclick="saveItem('finalQ')">Save Final Question</button>
    </div>

    <div class="card" id="inventoryCard"><h3>Content Inventory</h3><table class="data-table"><tbody id="contentTable"></tbody></table></div>
</div>

<script>
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(event.currentTarget) event.currentTarget.classList.add('active');
    }

    function insertMath(id, type) {
        const area = document.getElementById(id);
        let tag = (type==='sqrt') ? "$\\sqrt{x}$" : (type==='frac') ? "$\\frac{a}{b}$" : (type==='pow') ? "$x^{2}$" : "**Text**";
        const start = area.selectionStart;
        const end = area.selectionEnd;
        area.value = area.value.substring(0, start) + tag + area.value.substring(end);
        area.focus();
        updatePreview(id.charAt(0));
    }

    function updatePreview(p) {
        const txt = document.getElementById(p+'Text').value;
        const mathPreview = document.getElementById(p+'MathPreview');
        
        // تحديث النص مع دعم كسر السطور
        mathPreview.innerHTML = txt.replace(/\n/g, '<br>');

        // أمر إعادة المعالجة لـ MathJax v2.7
        if (window.MathJax) {
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, mathPreview]);
        }
    }

    function toggleInputs(p) {
        const isMcq = document.getElementById(p+'Type').value === 'mcq';
        document.getElementById(p+'McqArea').classList.toggle('hidden', !isMcq);
        document.getElementById(p+'GridArea').classList.toggle('hidden', isMcq);
    }

    function saveItem(type) {
        let key = (type === 'video') ? 'added_lessons' : (type === 'unitQ' ? 'added_questions' : 'final_exam_questions');
        let data = { id: Date.now(), type: type };
        const p = (type === 'unitQ') ? 'u' : 'f';

        if(type === 'video') {
            data.unitNum = document.getElementById('vUnit').value;
            data.title = document.getElementById('vTitle').value;
            data.videoURL = document.getElementById('vUrl').value;
        } else {
            data.qType = (type === 'unitQ') ? document.getElementById('uType').value : 'mcq';
            data.text = document.getElementById(p+'Text').value;
            data.unit = (type === 'unitQ') ? document.getElementById('uTarget').value : document.getElementById('fSet').value;
            if(data.qType === 'mcq') {
                data.options = [document.getElementById(p+'A')?.value, document.getElementById(p+'B')?.value, document.getElementById(p+'C')?.value, document.getElementById(p+'D')?.value];
            }
        }

        let db = JSON.parse(localStorage.getItem(key) || '[]');
        db.push(data);
        localStorage.setItem(key, JSON.stringify(db));
        alert("Saved!"); renderContent();
    }

    function renderContent() {
        const body = document.getElementById('contentTable'); body.innerHTML = '';
        ['added_lessons', 'added_questions', 'final_exam_questions'].forEach(key => {
            JSON.parse(localStorage.getItem(key) || '[]').forEach(item => {
                body.innerHTML += `<tr><td>${item.type}</td><td>${item.unitNum || item.unit}</td><td>${(item.title || item.text || '').substring(0,20)}</td><td><button onclick="deleteItem('${key}', ${item.id})">Delete</button></td></tr>`;
            });
        });
    }

    function deleteItem(k, id) {
        localStorage.setItem(k, JSON.stringify(JSON.parse(localStorage.getItem(k)).filter(i => i.id !== id)));
        renderContent();
    }

    window.onload = renderContent;
</script>
</body>
</html>
