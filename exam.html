<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALAL.TEK - SAT Practice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #3498db; 
            --dark: #1e293b; 
            --bg: #f1f5f9; 
            --green: #10b981; 
            --red: #ef4444; 
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* شريط المعلومات العلوي */
        .info-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #fff; 
            padding: 15px 25px; 
            border-radius: 15px; 
            margin-bottom: 25px; 
            border: 1px solid #e2e8f0;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .timer { font-weight: bold; font-size: 1.2rem; color: var(--red); display: flex; align-items: center; gap: 8px; }

        .question-block { 
            margin-bottom: 30px; 
            padding: 25px; 
            background: #fff; 
            border-radius: 15px; 
            border: 1px solid #e2e8f0; 
            transition: 0.3s;
        }

        .opt-label { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 15px; 
            border: 1px solid #edf2f7; 
            border-radius: 12px; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: 0.2s; 
        }

        .opt-label:hover { background: #f8fafc; border-color: var(--primary); }
        input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }

        /* حالات التصحيح */
        .correct-opt { background: #ecfdf5 !important; border-color: var(--green) !important; color: var(--green); font-weight: bold; }
        .wrong-opt { background: #fef2f2 !important; border-color: var(--red) !important; color: var(--red); }

        .submit-btn { 
            width: 100%; padding: 20px; background: var(--primary); color: white; border: none; 
            border-radius: 15px; font-size: 1.1rem; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .submit-btn:hover { background: #2980b9; transform: translateY(-2px); }

        #resultArea { display: none; text-align: center; padding: 40px; }
        .score-circle { 
            width: 150px; height: 150px; line-height: 150px; border-radius: 50%; 
            background: var(--primary); color: white; font-size: 2.5rem; margin: 20px auto; font-weight: bold; 
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
    </style>
</head>
<body>

<div class="container" id="quizWrapper">
    <div class="info-bar">
        <div style="font-weight: 600; color: var(--primary);">
            <i class="fas fa-user-circle"></i> <span id="stuNameDisplay">...</span>
        </div>
        <div class="timer" id="timerDisplay">
            <i class="fas fa-clock"></i> <span id="timeLeft">--:--</span>
        </div>
        <a href="home.html" style="text-decoration:none; color: #64748b; font-weight:600;"><i class="fas fa-times"></i> Exit</a>
    </div>
    
    <div id="quizContent"></div>

    <button class="submit-btn" id="finalSubmitBtn" onclick="processQuiz()">
        <i class="fas fa-paper-plane"></i> Submit My Answers
    </button>
</div>

<div class="container" id="resultArea">
    <h2 style="font-size: 2rem;">Quiz Completed!</h2>
    <p id="congratsMsg" style="font-size: 1.2rem; color: #64748b;"></p>
    <div class="score-circle" id="scoreValue">0%</div>
    <p id="detailedScore" style="font-weight: 600;"></p>
    <button onclick="window.location.reload()" class="submit-btn" style="background:#64748b; margin-top: 20px;">Review Answers</button>
    <a href="home.html" style="display:block; margin-top:20px; text-decoration:none; color: var(--primary); font-weight:bold;">Back to Dashboard</a>
</div>

<script>
    let timeLeft; 
    let timerInterval;

    window.onload = function() {
        const studentName = localStorage.getItem('student_name') || 'Student';
        document.getElementById('stuNameDisplay').innerText = studentName;
        
        // جلب الوقت من الأدمن (افتراضياً 10 دقائق إذا لم يحدد)
        const savedTime = parseInt(localStorage.getItem('quiz_duration')) || 10;
        timeLeft = savedTime * 60;

        loadQuestions();
        startTimer();
    };

    function startTimer() {
        timerInterval = setInterval(() => {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            document.getElementById('timeLeft').innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                processQuiz(); // تقديم تلقائي عند انتهاء الوقت
            }
            timeLeft--;
        }, 1000);
    }

    function loadQuestions() {
        const questions = JSON.parse(localStorage.getItem('added_questions') || '[]');
        const container = document.getElementById('quizContent');

        if(questions.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:50px;'>No questions available yet.</p>";
            document.getElementById('finalSubmitBtn').style.display = 'none';
            return;
        }

        questions.forEach((q, idx) => {
            const qDiv = document.createElement('div');
            qDiv.className = 'question-block';
            qDiv.id = `qBlock${idx}`;
            
            let imgPart = q.img ? `<img src="${q.img}" style="max-width:100%; border-radius:10px; margin:15px 0;">` : "";
            
            qDiv.innerHTML = `
                <p style="font-weight: bold; font-size: 1.1rem;">Question ${idx+1}</p>
                <p>${q.text}</p>
                ${imgPart}
                <div class="options-list">
                    ${['A', 'B', 'C', 'D'].map((letter, i) => `
                        <label class="opt-label" id="label-${idx}-${letter}">
                            <input type="radio" name="q${idx}" value="${letter}">
                            <span><strong>${letter})</strong> ${q.options[i]}</span>
                        </label>
                    `).join('')}
                </div>
                <div id="feedback-${idx}" style="margin-top:15px; display:none; font-weight:bold;"></div>
            `;
            container.appendChild(qDiv);
        });
    }

    function processQuiz() {
        clearInterval(timerInterval);
        const questions = JSON.parse(localStorage.getItem('added_questions') || '[]');
        let score = 0;

        questions.forEach((q, idx) => {
            const selected = document.querySelector(`input[name="q${idx}"]:checked`);
            const feedbackDiv = document.getElementById(`feedback-${idx}`);
            const correctLetter = q.correct; // يجب أن يكون A, B, C, أو D

            // تلوين الإجابة الصحيحة دائماً بالأخضر
            document.getElementById(`label-${idx}-${correctLetter}`).classList.add('correct-opt');

            if (selected) {
                if (selected.value === correctLetter) {
                    score++;
                } else {
                    // تلوين إجابة الطالب الخاطئة بالأحمر
                    document.getElementById(`label-${idx}-${selected.value}`).classList.add('wrong-opt');
                }
            }

            // إظهار التغذية الراجعة
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = selected && selected.value === correctLetter ? 
                `<span style="color:var(--green)">Correct!</span>` : 
                `<span style="color:var(--red)">Correct answer is: ${correctLetter}</span>`;
            
            // قفل الخيارات بعد التسليم
            document.querySelectorAll(`input[name="q${idx}"]`).forEach(input => input.disabled = true);
        });

        // إظهار النتائج
        const percent = Math.round((score / questions.length) * 100);
        document.getElementById('quizWrapper').style.overflow = 'visible';
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('scoreValue').innerText = percent + "%";
        document.getElementById('detailedScore').innerText = `You got ${score} out of ${questions.length} correct.`;
        document.getElementById('congratsMsg').innerText = percent >= 50 ? "Well done!" : "Keep practicing!";
        
        // التمرير لأعلى الصفحة لرؤية النتيجة
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>
