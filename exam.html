<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALAL.TEK - SAT Practice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                enableMenu: false
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #3498db; --dark: #1e293b; --bg: #f1f5f9; --green: #10b981; --red: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .info-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #fff; padding: 15px 25px; border-radius: 15px; 
            margin-bottom: 25px; border: 1px solid #e2e8f0; position: sticky; top: 10px; z-index: 100;
        }

        .calc-btn { background: var(--dark); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        #calcModal {
            display: none; position: fixed; top: 100px; right: 50px;
            width: 450px; height: 500px; background: white; border-radius: 15px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); z-index: 9999; overflow: hidden;
            border: 2px solid var(--dark); resize: both; 
        }
        .calc-header { 
            background: var(--dark); color: white; padding: 12px; 
            display: flex; justify-content: space-between; cursor: move; 
        }

        .question-block { margin-bottom: 30px; padding: 25px; background: #fff; border-radius: 15px; border: 1px solid #e2e8f0; }
        .opt-label { display: flex; align-items: center; gap: 12px; padding: 15px; border: 1px solid #edf2f7; border-radius: 12px; cursor: pointer; margin-top: 10px; }
        .correct-opt { background: #ecfdf5 !important; border-color: var(--green) !important; color: #065f46 !important; font-weight: bold; }
        .wrong-opt { background: #fef2f2 !important; border-color: var(--red) !important; color: #991b1b !important; }
        .grid-in-box { width: 100%; max-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.2rem; }

        .submit-btn { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        #resultArea { display: none; text-align: center; }
        .score-circle { width: 120px; height: 120px; line-height: 120px; border-radius: 50%; background: var(--primary); color: white; font-size: 2rem; margin: 20px auto; font-weight: bold; }
    </style>
</head>
<body>

<div class="container" id="quizWrapper">
    <div class="info-bar">
        <button class="calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i> Open Calculator</button>
        <div style="font-weight:bold; color:var(--red);" id="timerDisplay">00:00</div>
        <a href="home.html" style="text-decoration:none; color:#666;"><i class="fas fa-times"></i> Exit</a>
    </div>
    
    <div id="quizContent"></div>
    <button class="submit-btn" onclick="processQuiz()">Finish Exam</button>
</div>

<div id="calcModal">
    <div class="calc-header" id="calcHeader">
        <span><i class="fas fa-grip-lines"></i> Drag to Move</span>
        <i class="fas fa-times" onclick="toggleCalc()" style="cursor:pointer;"></i>
    </div>
    <iframe src="https://www.desmos.com/scientific?embed" style="width:100%; height:calc(100% - 40px); border:none;"></iframe>
</div>

<div class="container" id="resultArea">
    <div class="score-circle" id="scoreValue">0%</div>
    <p id="detailedScore"></p>
    <button onclick="location.reload()" class="submit-btn" style="background:#666;">Review Answers</button>
</div>

<script>
    let questionsData = [];
    let timeLeft;

    window.onload = function() {
        const savedTime = parseInt(localStorage.getItem('quiz_duration')) || 15;
        timeLeft = savedTime * 60;
        loadQuiz();
        startTimer();
        makeDraggable(document.getElementById("calcModal"));
    };

    function toggleCalc() {
        const m = document.getElementById('calcModal');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function startTimer() {
        const timerInt = setInterval(() => {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) { clearInterval(timerInt); processQuiz(); }
            timeLeft--;
        }, 1000);
    }

    function loadQuiz() {
        questionsData = JSON.parse(localStorage.getItem('added_questions') || '[]');
        const container = document.getElementById('quizContent');
        if(!questionsData.length) return container.innerHTML = "No questions found.";

        let fullHtml = ""; // تجميع الكود في متغير واحد أولاً
        questionsData.forEach((q, i) => {
            fullHtml += `
                <div class="question-block">
                    <p style="color:var(--primary); font-weight:bold;">Question ${i+1}</p>
                    <div class="math-content">${q.text}</div>
                    ${q.img ? `<img src="${q.img}" style="max-width:100%; margin-top:10px;">` : ''}
                    <div style="margin-top:15px;">
                        ${q.type === 'mcq' ? 
                            ['A','B','C','D'].map((l, idx) => `
                                <label class="opt-label" id="label-${i}-${l}">
                                    <input type="radio" name="q${i}" value="${l}"> ${l}) ${q.options[idx]}
                                </label>`).join('') :
                            `<input type="text" class="grid-in-box" id="grid-${i}" placeholder="Enter answer...">`
                        }
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = fullHtml;

        // إجبار محرك الرياضيات على العمل فوراً
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise().then(() => {
                console.log("Math rendered successfully
